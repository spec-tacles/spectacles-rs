parameters:
  name: ''  # defaults for any parameters that aren't specified
  vmImage: ''
  toolchain: 'stable'
  
jobs:
  - job: ${{ parameters.name }}
    pool:
      vmImage: ${{ parameters.vmImage }}
    variables:
      tc: ${{ parameters.toolchain }}
    steps:
      - bash: |
          curl -o rustup-init.sh https://sh.rustup.rs -sSf
          sh rustup-init.sh --default-toolchain $(tc) -y
        displayName: 'Install Rust'

      - bash: |
          source $HOME/.cargo/env
          cargo build -p spectacles --release
          tar -zcvf spectacles-$(build.my_tag)-$(TARGET).tar.gz target/release/spectacles
        displayName: 'Build Spectacles'
      - bash: |
          MY_TAG="$(Build.SourceBranch)"
          MY_TAG=${MY_TAG#refs/tags/}
          echo $MY_TAG
          echo "##vso[task.setvariable variable=build.my_tag]$MY_TAG"
        displayName: 'Create tag variable.'
      - task: GithubRelease@0
        displayName: 'Package GitHub release'
        inputs:
          target: '$(build.sourceVersion)'
          tagSource: 'manual'
          tag: '$(build.my_tag)'
          githubConnection: my-account
          repositoryName: spec-tacles-spectacles-rs
          assets: $(Build.ArtifactStagingDirectory)/*.tar.gz