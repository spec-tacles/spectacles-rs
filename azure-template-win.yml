parameters:
  name: ''  # defaults for any parameters that aren't specified
  vmImage: ''
  toolchain: 'stable'

jobs:
  - job: ${{ parameters.name }}
    pool:
      vmImage: ${{ parameters.vmImage }}
    variables:
      tc: ${{ parameters.toolchain }}
    steps:
      - powershell: |
          echo "2: $env:TC"
          echo "4: $(tc)"
          Invoke-WebRequest -Uri "https://win.rustup.rs" -OutFile "rustup-init.exe"
          &".\rustup-init.exe" --default-toolchain $(tc) -y
        displayName: 'Install Rust'
        
      - powershell: |
          &"$env:USERPROFILE\.cargo\bin\cargo" build -p spectacles --release
        displayName: 'Build Spectacles'
      
      - powershell: |
          MY_TAG="$(Build.SourceBranch)"
          MY_TAG=${MY_TAG#refs/tags/}
          echo $MY_TAG
          echo "##vso[task.setvariable variable=build.my_tag]$MY_TAG"
        displayName: "Create tag variable."

      - task: GithubRelease@0
        displayName: 'Package GitHub release'
        condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'))
        inputs:
          githubConnection: 'my-account'
          target: '$(build.sourceVersion)'
          tagSource: 'manual'
          tag: '$(build.my_tag)'
          repositoryName: spec-tacles-spectacles-rs
          assets: $(Build.ArtifactStagingDirectory)/*.exe